package com.naipy.alpha.modules.user_address.service;

import com.naipy.alpha.modules.address.models.Address;
import com.naipy.alpha.modules.address.models.AddressDTO;
import com.naipy.alpha.modules.address.models.AddressEnriched;
import com.naipy.alpha.modules.address.service.AddressService;
import com.naipy.alpha.modules.exceptions.services.InvalidParameterException;
import com.naipy.alpha.modules.utils.ChargeAddressObject;
import com.naipy.alpha.modules.utils.ConstantVariables;
import com.naipy.alpha.modules.utils.ServiceUtils;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;


class UserAddressServiceTest extends ServiceUtils {

    @Mock
    AddressService addressService;

    @InjectMocks
    UserAddressService userAddressService;

    @BeforeEach
    void setup () {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void addAddressToUser() {
        Address addressExpected = Address.builder()
                .id(ChargeAddressObject.uuidNonAutogenerated())
                .street("Rua Gasparini")
                .neighborhood("Vila Normandia")
                .zipcode("09635130")
                .city("São Bernardo do Campo")
                .state("São Paulo")
                .country("Brasil")
                .latitude("-23.6509129")
                .longitude("-46.57409550000001")
                .build();
        AddressEnriched addressEnrichedExpected = AddressEnriched.builder()
                .address(addressExpected)
                .streetNumber("130")
                .build();

        String zipCode = "09635-130";
        String streetNumber = "130";

        Mockito.when(addressService.getAddressAndAddIfDoesntExists(zipCode)).thenReturn(new AddressDTO(ChargeAddressObject.getOneAddress()));
        AddressDTO addressDTO = addressService.getAddressAndAddIfDoesntExists(zipCode);

        Mockito.when(userAddressService.getExactAddressOfUser(addressDTO, streetNumber)).thenReturn(ChargeAddressObject.getOneAddressEnriched());
        AddressEnriched addressEnriched = userAddressService.getExactAddressOfUser(addressDTO, streetNumber);
        Assertions.assertEquals(addressEnrichedExpected, addressEnriched);
    }

    @Test
    void getExactAddressOfUser() {
        AddressEnriched addressEnrichedExpected = ChargeAddressObject.getOneAddressEnriched();
        AddressDTO addressDTO = new AddressDTO(ChargeAddressObject.getOneAddress());
        String streetNumber = "130";

        Mockito.when(addressService.getAddressEnrichedByCompleteAddress(Mockito.anyString())).thenReturn(ChargeAddressObject.getOneAddressEnriched());
        AddressEnriched addressEnrichedResult = userAddressService.getExactAddressOfUser(addressDTO, streetNumber);

        Assertions.assertEquals(addressEnrichedExpected, addressEnrichedResult);
    }

    @Test
    void getExactAddressOfUser_ThrowInvalidParameterException() {
        InvalidParameterException addressEnrichedExpected = new InvalidParameterException("Parameter is not valid for searching in the MapsAPI. Param: " + ConstantVariables.EMPTY_STRING);
        AddressDTO emptyAddressDTO = new AddressDTO(ChargeAddressObject.getOneEmptyAddress());
        String streetNumber = ConstantVariables.EMPTY_STRING;

        Mockito.when(addressService.getAddressEnrichedByCompleteAddress(Mockito.anyString())).thenReturn(ChargeAddressObject.getOneAddressEnriched());
        InvalidParameterException exceptionResult = Assertions.assertThrows(InvalidParameterException.class, () -> {userAddressService.getExactAddressOfUser(emptyAddressDTO, streetNumber);});

        Assertions.assertEquals(addressEnrichedExpected, exceptionResult);
    }
}